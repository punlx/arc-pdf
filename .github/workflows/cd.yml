name: Frontend CI

on:
  push:
    branches: [main]
    paths: ['**']
  pull_request:
    paths: ['**']
  workflow_dispatch:

jobs:
  build-check:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clone repo
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node + cache Yarn
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      # 3Ô∏è‚É£ Install deps
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # 4Ô∏è‚É£ (optional) Lint
      # - run: yarn lint

      # 5Ô∏è‚É£ Unit / component tests (Vitest project=unit)
      - name: Run unit tests
        run: yarn test

      # 6Ô∏è‚É£ Install Playwright browsers (cached)
      - name: Install Playwright browsers
        uses: microsoft/playwright-github-action@v1
        with:
          # installs browsers & re-uses cache between runs
          install-deps: true

      # 7Ô∏è‚É£ Storybook interaction tests (Vitest project=storybook)
      - name: Run Storybook interaction tests
        run: yarn test:storybook

      # 8Ô∏è‚É£ Build production bundle (Vite + TSC)
      - name: Build production bundle
        run: yarn build

      # 9Ô∏è‚É£ Build static Storybook
      - name: Build static Storybook
        run: yarn build-storybook --quiet

      # üîü Ensure Dockerfile.prod builds
      - name: Docker build (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.prod
          push: false

      # (optional) Upload coverage report
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage
