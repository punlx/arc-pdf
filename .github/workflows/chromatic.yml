# .github/workflows/chromatic.yml
name: Chromatic visual tests

on:
  #######################################################################
  # 1) à¸•à¸£à¸§à¸ˆ UI à¸•à¸­à¸™à¹€à¸›à¸´à¸” PR â†’ main  (à¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œ UI à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™)
  #######################################################################
  pull_request:
    branches: [main] # à¹€à¸›à¹‰à¸² = main
    types: [opened, synchronize, reopened]
    paths:
      - 'src/components/ui/**' # ğŸ” à¹€à¸‰à¸à¸²à¸° UI component
      # â†³ à¸–à¹‰à¸²à¸¡à¸µ story à¹„à¸§à¹‰à¸„à¸™à¸¥à¸°à¸—à¸µà¹ˆ à¹€à¸à¸´à¹ˆà¸¡ pattern à¹€à¸à¸´à¹ˆà¸¡à¹„à¸”à¹‰ à¹€à¸Šà¹ˆà¸™:
      # - '.storybook/**'
      # - 'package.json'
      # - 'yarn.lock'

  #######################################################################
  # 2) à¸•à¸±à¹‰à¸‡ baseline à¹ƒà¸«à¸¡à¹ˆà¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ push à¹€à¸‚à¹‰à¸²à¸à¸´à¹ˆà¸‡ main
  #    (à¸ˆà¸°à¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™à¹€à¸¡à¸·à¹ˆà¸­ PR merge) â€” à¹ƒà¸ªà¹ˆ path filter à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™à¹„à¸”à¹‰
  #######################################################################
  push:
    branches: [main]
    paths:
      - 'src/components/ui/**'

  # 3) à¸¢à¸±à¸‡à¸ªà¸±à¹ˆà¸‡à¸£à¸±à¸™à¸¡à¸·à¸­à¹„à¸”à¹‰à¹€à¸ªà¸¡à¸­
  workflow_dispatch:

jobs:
  chromatic:
    runs-on: ubuntu-latest
    name: Publish to Chromatic ğŸ–¼ï¸

    steps:
      # â”€â”€ 1. Checkout (à¸•à¹‰à¸­à¸‡ fetch-depth:0 à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™ commit graph) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ 2. Node + dependency cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - run: yarn install --frozen-lockfile

      # â”€â”€ 3. à¹€à¸£à¸µà¸¢à¸ Chromatic CLI à¸œà¹ˆà¸²à¸™ Action â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Chromatic
        uses: chromaui/action@latest # pin @v13 à¹„à¸”à¹‰à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}

          # à¹ƒà¸«à¹‰ main à¸£à¸±à¸š snapshot à¹ƒà¸«à¸¡à¹ˆà¹€à¸›à¹‡à¸™ baseline à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
          autoAcceptChanges: 'main'

          # à¸–à¹‰à¸²à¸¡à¸µ diff â†’ à¹ƒà¸«à¹‰ workflow fail (PR à¸‚à¸¶à¹‰à¸™à¹à¸”à¸‡)
          exitZeroOnChanges: false

          # à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¸ˆà¸š job à¹€à¸¥à¸¢ (à¹€à¸£à¹‡à¸§à¸à¸§à¹ˆà¸²)
          exitOnceUploaded: true
